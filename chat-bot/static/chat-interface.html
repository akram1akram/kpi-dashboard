<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Chat Bot Interface</title> <style>
        /* --- All CSS rules go here --- */

        /* Apply base styles to the body or main container within the iframe */
        body { 
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
          margin: 0; /* Remove default body margin if needed */
          background-color: #1c1c1e; /* Slightly darker main background */
          color: #ffffff; /* Default text color */
          display: flex; /* Ensure chat container takes up space if body is parent */
          height: 100vh; /* Ensure body takes full viewport height */
          box-sizing: border-box;
        }

        .chat-container {
          width: 100%;
          /* height: 400px; Remove fixed height, let flex handle it */
          /* border: 1px solid #ccc; Remove light border, maybe add a subtle dark one if desired */
          border: 1px solid #3a3a3c; /* Subtle darker border */
          display: flex;
          flex-direction: column;
          flex-grow: 1; /* Allow container to grow */
          overflow: hidden; /* Prevent scrollbars on container itself */
          background-color: #1c1c1e; /* Match body background */
        }

        .chat-messages {
          flex: 1;
          overflow-y: auto; /* Only messages area should scroll */
          padding: 10px;
          background-color: #1c1c1e; /* Match container background */
          color: #ffffff; /* Ensure default text is white */
        }

        .message {
          margin-bottom: 8px; /* Use margin-bottom for spacing */
          padding: 10px 15px;
          border-radius: 18px; /* More rounded corners */
          max-width: 75%;
          line-height: 1.4;
          word-wrap: break-word; /* Ensure long words break */
        }

        .user-message {
          background-color: #007aff; /* Apple blue */
          color: white;
          margin-left: auto; /* Align right */
          margin-right: 5px; /* Small margin from edge */
        }

        .bot-message {
          background-color: #3a3a3c; /* Dark grey bubble */
          color: #ffffff;
          /* border: 1px solid #ddd; Remove light border */
          margin-right: auto; /* Align left */
          margin-left: 5px; /* Small margin from edge */
        }

        .chat-input {
          display: flex;
          padding: 10px;
          background-color: #2c2c2e; /* Slightly lighter background for input area */
          border-top: 1px solid #3a3a3c; /* Separator line */
        }

        #messageInput {
          flex: 1;
          padding: 10px 15px;
          margin-right: 8px;
          border: 1px solid #3a3a3c; /* Darker border */
          border-radius: 18px; /* Match message bubble rounding */
          background-color: #3a3a3c; /* Dark input background */
          color: #ffffff; /* White text input */
          font-size: 1rem; /* Ensure readable font size */
        }

        #messageInput::placeholder {
          color: #8e8e93; /* Lighter grey placeholder text */
        }

        #sendButton {
          padding: 10px 16px;
          background: #007aff; /* Apple blue */
          color: white;
          border: none;
          border-radius: 18px; /* Match rounding */
          cursor: pointer;
          font-weight: bold;
          font-size: 1rem;
          transition: background-color 0.2s ease; /* Smooth hover effect */
        }

        #sendButton:hover {
          background-color: #005ecb; /* Slightly darker blue on hover */
        }

        /* Optional: Add scrollbar styling for webkit browsers (Chrome, Safari) */
        .chat-messages::-webkit-scrollbar {
          width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
          background: #2c2c2e;
        }

        .chat-messages::-webkit-scrollbar-thumb {
          background-color: #555;
          border-radius: 3px;
        }

        /* Optional: CSS for Typing Indicator (if you enable JS) */
        /*
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            margin: 0 1px;
            background-color: #8e8e93;
            border-radius: 50%;
            opacity: 0.4;
            animation: typing 1s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.15s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.3s; }

        @keyframes typing {
            0%, 100% { opacity: 0.4; transform: scale(0.8); }
            40% { opacity: 1; transform: scale(1); }
        }
        */

    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input">
            <input type="text" id="messageInput" placeholder="Ask about your KPIs...">
            <button id="sendButton">Send</button>
        </div>
    </div>

    <script>
        // --- All JavaScript goes here ---

        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // Add user message
            addMessage(message, 'user');
            messageInput.value = '';

            // --- Optional: Add Typing Indicator ---
            // addTypingIndicator(); // Call function to show indicator

            try {
                const response = await fetch('/chat', { // Ensure this path is correct on your server
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message })
                });

                // --- Optional: Remove Typing Indicator ---
                // removeTypingIndicator(); // Call function to remove indicator

                const data = await response.json();
                if (data.error) {
                    addMessage('Error: ' + data.error, 'bot');
                } else {
                    addMessage(data.response, 'bot');
                }
            } catch (error) {
                // --- Optional: Remove Typing Indicator if error ---
                // removeTypingIndicator();
                console.error("Chatbot request failed:", error); // Log error for debugging
                addMessage('Sorry, I encountered an error communicating with the server.', 'bot');
            }
        }

        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', `${sender}-message`);
            messageDiv.textContent = text; // Using textContent for security (prevents HTML injection)
            chatMessages.appendChild(messageDiv);

            // --- Smooth Scrolling ---
            chatMessages.scrollTo({
                top: chatMessages.scrollHeight,
                behavior: 'smooth'
            });
            // --- End Smooth Scrolling ---
        }

        // --- Optional: Typing Indicator Functions ---
        // function addTypingIndicator() {
        //     const indicatorDiv = document.createElement('div');
        //     indicatorDiv.classList.add('message', 'bot-message', 'typing-indicator');
        //     indicatorDiv.innerHTML = '<span>.</span><span>.</span><span>.</span>'; // Simple dot animation (needs CSS above)
        //     indicatorDiv.id = 'typingIndicator'; // Give it an ID to find it easily
        //     chatMessages.appendChild(indicatorDiv);
        //     chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' });
        // }

        // function removeTypingIndicator() {
        //     const indicator = document.getElementById('typingIndicator');
        //     if (indicator) {
        //         chatMessages.removeChild(indicator);
        //     }
        // }
        // --- End Optional Typing Indicator ---


        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent potential form submission if wrapped in a form
                sendMessage();
            }
        });

        // Keep your iframe communication functions
        function highlightDashboardElement(elementId) {
            // Communicate with Looker Studio to highlight specific elements
            window.parent.postMessage({
                type: 'highlight',
                elementId: elementId
            }, '*'); // Consider specifying the target origin instead of '*' for security
        }

        function updateDashboardFilters(filters) {
            // Update dashboard filters based on chat interaction
            window.parent.postMessage({
                type: 'updateFilters',
                filters: filters
            }, '*'); // Consider specifying the target origin
        }

        function getContextualData() {
            // Get current dashboard context
            window.parent.postMessage({
                type: 'getContext'
            }, '*'); // Consider specifying the target origin
        }

    </script>
</body>
</html>